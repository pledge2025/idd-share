<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8">
  <title>Potpiši obećanje</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Potpiši obećanje, preuzmi, odštampaj ili podijeli na mrežama. Podaci se ne čuvaju.">
  <style>
    :root{
      --bg:#f7fafc; --card:#ffffff; --ink:#111827; --muted:#4b5563; --border:#e5e7eb;
      --radius:16px; --shadow:0 10px 24px rgba(0,0,0,.08);
      --accent:#003869;
    }
    *{box-sizing:border-box}
    body{margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; background:var(--bg); color:var(--ink)}
    .container{max-width:980px; margin-inline:auto; padding:24px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px}
    h1{margin:0 0 12px; font-size:1.8rem}
    p.muted{color:var(--muted); margin-top:6px}

    form{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    @media (max-width:720px){ form{grid-template-columns:1fr} }
    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-weight:600}
    input{background:#fff; color:var(--ink); border:1px solid #d1d5db; border-radius:10px; padding:10px}

    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .btn{appearance:none; border:1px solid #d1d5db; background:#fff; color:var(--ink); padding:10px 14px; border-radius:10px; cursor:pointer; text-decoration:none; display:inline-block}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent); font-weight:700}
    .btn[aria-disabled="true"]{opacity:.55; pointer-events:none; cursor:not-allowed}

    .pledge-section{margin:16px 0 6px}
    .pledge-section .label{margin-bottom:6px}
    .pledge-preview{line-height:1.6}
    .pledge-preview p{margin:0 0 10px}
    .pledge-preview ul{margin:8px 0 16px 0; padding-left:0; list-style:none}
    .pledge-preview li{position:relative; padding-left:32px; margin:6px 0;}
    .pledge-preview li::before{content:"•"; position:absolute; left:0; top:0; line-height:1.6; color:var(--ink);}

    .canvas-wrap{margin-top:16px}
    #certImg{width:100%; height:auto; display:block; background:#fff; border:1px solid #d1d5db; border-radius:12px}

    .sr-only{
      position:absolute !important; width:1px !important; height:1px !important;
      padding:0 !important; margin:-1px !important; overflow:hidden !important;
      clip:rect(0,0,0,0) !important; white-space:nowrap !important; border:0 !important;
    }

    @media print{
      @page { size: A4 portrait; margin: 0; }
      html, body, .container { margin:0 !important; padding:0 !important; }
      body{background:white; color:black}
      .no-print{display:none !important}
      .print-only{display:block !important}
      #printCertImg{
        display:block; width:210mm; height:auto; max-width:100%;
        image-rendering: optimizeQuality;
        page-break-inside: avoid; break-inside: avoid; page-break-after: avoid;
      }
    }
    .print-only{display:none}
    .footer{margin-top:20px; color:var(--muted); font-size:.9rem}
  </style>
</head>
<body>
  <div class="container">
    <div class="card no-print">
      <h1>Potpiši obećanje</h1>
      <p class="muted"><i>*Napomena: Popuni svoje podatke, generiši sertifikat, a potom ga preuzmi, odštampaj ili podijeli. (Podaci se ne čuvaju.)</i></p>

      <section class="pledge-section" aria-labelledby="pledge-heading">
        <div class="label" id="pledge-heading">Tekst obećanja</div>
        <div class="pledge-preview">
          <p>Uviđajući vrijednost i značaj demokratije, ali i prepoznajući izazove i prijetnje sa kojima se ona suočava, globalno i u Crnoj Gori, ovim putem se obavezujem da ću u narednih 365 dana, u skladu sa svojom ulogom, mogućnostima i kapacitetima:</p>
          <ul>
            <li><b>Aktivno učestvovati u demokratskim procesima</b> — koristiti pravo glasa, podsticati građansko angažovanje i doprinositi odgovornosti institucija.</li>
            <li><b>Štititi ljudska prava i jednakost</b> — boriti se protiv diskriminacije i omogućiti puno učešće svih građana i građanki, uključujući žene, mlade i manjinske zajednice.</li>
            <li><b>Promovisati kulturu dijaloga i istinitog informisanja</b> — poštovati različita mišljenja, graditi konsenzus i suprotstavljati se dezinformacijama, uz podršku slobodnih i nezavisnih medija.</li>
            <li><b>Boriti se protiv korupcije i zloupotreba moći</b> — zahtijevati transparentnost, vladavinu prava i izgradnju odgovornih institucija.</li>
            <li><b>Jačati demokratske vrijednosti u zajednici i šire</b> — volontirati, podsticati aktivizam, solidarnost i povezivanje sa drugima u Crnoj Gori i svijetu.</li>
          </ul>
        </div>
      </section>

      <textarea id="pledgeText" class="sr-only" aria-hidden="true">
Uviđajući vrijednost i značaj demokratije, ali i prepoznajući izazove i prijetnje sa kojima se ona suočava, globalno i u Crnoj Gori, ovim putem se obavezujem da ću u narednih 365 dana, u skladu sa svojom ulogom, mogućnostima i kapacitetima:

• Aktivno učestvovati u demokratskim procesima — koristiti pravo glasa, podsticati građansko angažovanje i doprinositi odgovornosti institucija.
• Štititi ljudska prava i jednakost — boriti se protiv diskriminacije i omogućiti puno učešće svih građana i građanki, uključujući žene, mlade i manjinske zajednice.
• Promovisati kulturu dijaloga i istinitog informisanja — poštovati različita mišljenja, graditi konsenzus i suprotstavljati se dezinformacijama, uz podršku slobodnih i nezavisnih medija.
• Boriti se protiv korupcije i zloupotreba moći — zahtijevati transparentnost, vladavinu prava i izgradnju odgovornih institucija.
• Jačati demokratske vrijednosti u zajednici i šire — volontirati, podsticati aktivizam, solidarnost i povezivanje sa drugima u Crnoj Gori i svijetu.
      </textarea>

      <form id="form">
        <div class="field">
          <label for="fname" class="label">Ime</label>
          <input id="fname" name="fname" required autocomplete="given-name" placeholder="Ime">
        </div>
        <div class="field">
          <label for="lname" class="label">Prezime</label>
          <input id="lname" name="lname" required autocomplete="family-name" placeholder="Prezime">
        </div>
        <div class="field">
          <label for="date" class="label">Datum</label>
          <input id="date" name="date" type="date" required>
        </div>
        <div class="field">
          <label class="label">Saglasnost za korišćenje imena u objavama</label>
          <label for="consent"><input id="consent" type="checkbox"> <span>Saglasan/na sam da se moje ime koristi u objavama</span></label>
        </div>

        <div class="field" style="grid-column:1 / -1">
          <div class="actions">
            <button id="genBtn" class="btn primary" type="button">Generiši sertifikat</button>
            <button id="dlBtn" class="btn" type="button" aria-disabled="true">Preuzmi PNG</button>
            <button id="printBtn" class="btn" type="button" aria-disabled="true">Štampaj</button>
          </div>

          <!-- Social share (SSS-powered). WhatsApp & Telegram removed -->
          <div class="actions">
            <a class="btn" data-share="x" href="#">X</a>
            <a class="btn" data-share="facebook" href="#">Facebook</a>
            <a class="btn" data-share="linkedin" href="#">LinkedIn</a>
            <a class="btn" data-share="email" href="#">Email</a>
          </div>

          <div id="status" class="sr-only" aria-live="polite"></div>
        </div>
      </form>

      <div class="canvas-wrap">
        <img id="certImg" alt="Pregled sertifikata" loading="lazy" />
      </div>
    </div>

    <div class="print-only">
      <img id="printCertImg" alt="Sertifikat za štampu" loading="lazy">
    </div>
  </div>

  <!-- Simple Social Sharing (SSS) -->
  <script>
  (function(){
    function getShareUrls(opts){
      const u = (opts.url || location.href).trim();
      const text = (opts.text || '').trim();
      const title = (opts.title || document.title).trim();
      const hashtags = (opts.hashtags || '').replace(/#/g,'').split(/[,\s]+/).filter(Boolean).join(',');
      const via = (opts.via || '').replace(/^@/,'').trim();

      const enc = encodeURIComponent;
      const eUrl = enc(u);
      const eText = enc(text);
      const eTitle = enc(title);

      const xParams = new URLSearchParams();
      if (text) xParams.set('text', text);
      xParams.set('url', u);
      if (hashtags) xParams.set('hashtags', hashtags);
      if (via) xParams.set('via', via);

      return {
        x: `https://x.com/intent/tweet?${xParams.toString()}`,
        facebook: `https://www.facebook.com/sharer/sharer.php?u=${eUrl}${text ? '&quote='+eText : ''}`,
        linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${eUrl}`,
        email: `mailto:?subject=${eTitle}&body=${eText ? eText + '%0A%0A' : ''}${eUrl}`
      };
    }

    async function webShare(opts, fileDataUrl){
      if (!('share' in navigator)) return false;
      const shareData = { title: opts.title || document.title, text: opts.text || '', url: opts.url || location.href };
      if (fileDataUrl && 'canShare' in navigator){
        try{
          const blob = await (await fetch(fileDataUrl)).blob();
          const f = new File([blob], opts.filename || 'share.png', { type: blob.type || 'image/png' });
          const withFile = { ...shareData, files: [f] };
          if (navigator.canShare(withFile)){ await navigator.share(withFile); return true; }
        }catch(_){}
      }
      try { await navigator.share(shareData); return true; } catch(e){ return false; }
    }

    function wireShareButtons(opts){
      const urls = getShareUrls(opts);
      document.querySelectorAll('[data-share]').forEach(el=>{
        const t = el.dataset.share;
        if (t === 'native'){
          const replacement = el.cloneNode(true);
          el.replaceWith(replacement);
          replacement.addEventListener('click', async e=>{
            e.preventDefault();
            const ok = await webShare(opts, opts.fileDataUrl);
            if (!ok){ window.open(urls.x,'_blank','noopener,noreferrer'); }
          });
        } else if (urls[t]){
          el.setAttribute('href', urls[t]);
          el.setAttribute('target', '_blank');
          el.setAttribute('rel', 'noopener noreferrer');
        }
      });
      return urls;
    }

    window.SSS = { getShareUrls, webShare, wireShareButtons };
  })();
  </script>

  <!-- App logic -->
  <script>
    (function(){
      const genBtn = document.getElementById('genBtn');
      const dlBtn = document.getElementById('dlBtn');
      const printBtn = document.getElementById('printBtn');
      const pledgeTextEl = document.getElementById('pledgeText');
      const statusEl = document.getElementById('status');

      const certImg = document.getElementById('certImg');
      const printCertImg = document.getElementById('printCertImg');

      const fname = document.getElementById('fname');
      const lname = document.getElementById('lname');
      const date = document.getElementById('date');
      const consentEl = document.getElementById('consent');
      try { date.valueAsDate = new Date(); } catch {}

      const BASE_W = 1000, BASE_H = 1400;
      const CAMPAIGN_URL = "https://sites.google.com/ndi.org/idd2025mne/moje-obe%C4%87anje";
      const CAMPAIGN_YEAR = 2025;
      const HASHTAGS = '#IDD2025 #DanDemokratije';
      const HASHTAGS_CSV = HASHTAGS.replace(/#/g,'').split(/\s+/).filter(Boolean).join(',');

      const ua = navigator.userAgent;
      const isIOS = /iP(hone|ad|od)/i.test(ua);
      const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);

      // Slightly lower scale for mobile to keep data sizes sane
      const EXPORT_SCALE = isMobile ? 1.7 : 2.4;

      // Will hold the latest exports
      let last = { pngDataUrl: null, jpegDataUrl: null, blobUrl: null, filename: null };

      function getAccent(){ return '#003869'; }

      function drawWrapped(context, text, x, y, maxWidth, lineHeight){
        const words = text.split(/\s+/);
        let line = '';
        for (let i=0; i<words.length; i++){
          const test = line ? line + ' ' + words[i] : words[i];
          if (context.measureText(test).width > maxWidth){
            context.fillText(line, x, y);
            line = words[i];
            y += lineHeight;
          } else {
            line = test;
          }
        }
        if (line){ context.fillText(line, x, y); }
        return y;
      }

      function wrapLines(context, text, maxWidth){
        const words = text.split(/\s+/);
        const lines = [];
        let line = '';
        for (let i=0; i<words.length; i++){
          const test = line ? line + ' ' + words[i] : words[i];
          if (context.measureText(test).width > maxWidth){
            lines.push(line);
            line = words[i];
          } else {
            line = test;
          }
        }
        if (line) lines.push(line);
        return lines;
      }

      function renderParagraphs(context, text, baseX, startY, maxW, lineHeight){
        const paras = text.replace(/\r/g,'').split('\n');
        let y = startY;
        const bulletGap = 16, bulletIndent = 28, bulletBaselineNudge = 10;
        for (let raw of paras){
          const line = raw.trimEnd();
          if (!line.trim()){ y += lineHeight; continue; }
          const isBullet = /^([•\-])\s+/.test(line);
          if (isBullet){
            const content = line.replace(/^([•\-])\s+/, '');
            const bulletX = baseX;
            const textX = baseX + bulletIndent + bulletGap;
            const avail = maxW - (bulletIndent + bulletGap);
            context.beginPath();
            context.fillStyle = '#111827';
            context.arc(bulletX + bulletIndent/2, y - bulletBaselineNudge, 4, 0, Math.PI*2);
            context.fill();
            y = drawWrapped(context, content, textX, y, avail, lineHeight);
            y += lineHeight;
          } else {
            y = drawWrapped(context, line, baseX, y, maxW, lineHeight);
            y += lineHeight;
          }
        }
        return y;
      }

      function drawCertificate(context, { first, last, dateStr, pledge, accent }){
        context.clearRect(0, 0, BASE_W, BASE_H);
        context.fillStyle = '#ffffff';
        context.fillRect(0, 0, BASE_W, BASE_H);

        const pad = 64;
        const bodyPad = 70;

        // Borders
        context.strokeStyle = accent;
        context.lineWidth = 6;
        context.strokeRect(pad, pad, BASE_W - pad*2, BASE_H - pad*2);

        context.strokeStyle = accent;
        context.lineWidth = 3;
        context.setLineDash([10,8]);
        context.strokeRect(pad+18, pad+18, BASE_W - (pad+18)*2, BASE_H - (pad+18)*2);
        context.setLineDash([]);

        // Title
        context.fillStyle = '#111827';
        context.textAlign = 'center';
        context.font = 'bold 40px Georgia, "Times New Roman", serif';
        context.fillText('MOJE OBEĆANJE', BASE_W/2, 180);

        // Subtitle
        context.font = '24px Georgia, "Times New Roman", serif';
        context.fillStyle = '#374151';
        context.fillText('Povodom 15. septembra — Međunarodnog dana demokratije', BASE_W/2, 230);

        // Name
        const fullName = (first + ' ' + last).trim();
        context.font = 'bold 40px Georgia, "Times New Roman", serif';
        context.fillStyle = '#111827';
        context.fillText(fullName || '—', BASE_W/2, 300);

        // Rule under name
        context.strokeStyle = '#111827';
        context.lineWidth = 2;
        const nameWidth = context.measureText(fullName || '—').width;
        const ruleW = Math.min(720, Math.max(360, nameWidth + 80));
        context.beginPath();
        context.moveTo((BASE_W - ruleW)/2, 318);
        context.lineTo((BASE_W + ruleW)/2, 318);
        context.stroke();

        // Body
        context.textAlign = 'left';
        context.fillStyle = '#111827';
        context.font = '24px Georgia, "Times New Roman", serif';
        const bodyX = pad + bodyPad;
        const bodyY = 380;
        const bodyW = BASE_W - (pad + bodyPad) * 2;
        const lineH = 36;
        renderParagraphs(context, pledge.trim(), bodyX, bodyY, bodyW, lineH);

        // Footer (date + signature)
        context.font = '20px Georgia, "Times New Roman", serif';
        context.fillStyle = '#374151';
        const leftX = pad + bodyPad;
        const rightX = BASE_W - pad - bodyPad;

        context.fillText('Datum:', leftX, BASE_H - 180);
        context.fillStyle = '#111827';
        context.fillText(dateStr || '—', leftX + 90, BASE_H - 180);

        context.strokeStyle = '#111827';
        context.lineWidth = 2;
        context.beginPath();
        context.moveTo(rightX - 320, BASE_H - 190);
        context.lineTo(rightX, BASE_H - 190);
        context.stroke();
        context.fillStyle = '#374151';
        context.textAlign = 'right';
        context.fillText('Potpis', rightX - 120, BASE_H - 160);

        // Closing sentence
        const closing = 'Potpisivanjem ove izjave postajem dio globalne zajednice koja slavi i jača demokratiju — danas i svakoga dana.';
        context.textAlign = 'center';
        context.fillStyle = '#374151';
        context.font = '14px Georgia, "Times New Roman", serif';
        const closingMaxW = BASE_W - pad*2 - 100;
        const lines = wrapLines(context, closing, closingMaxW);
        const startY = BASE_H - 100 - ((lines.length - 1) * 26) / 2;
        lines.forEach((ln, i) => context.fillText(ln, BASE_W/2, startY + i * 26));
      }

      function renderHighResDataUrl(payload, type='image/png', quality){
        const SCALE = EXPORT_SCALE;
        const off = document.createElement('canvas');
        off.width = Math.round(BASE_W * SCALE);
        off.height = Math.round(BASE_H * SCALE);
        const octx = off.getContext('2d');
        octx.setTransform(SCALE, 0, 0, SCALE, 0, 0);
        drawCertificate(octx, payload);
        return off.toDataURL(type, quality);
      }

      function dataUrlToBlobUrl(dataUrl){
        const bin = atob(dataUrl.split(',')[1]);
        const arr = new Uint8Array(bin.length);
        for (let i=0; i<bin.length; i++) arr[i] = bin.charCodeAt(i);
        const mime = dataUrl.substring(5, dataUrl.indexOf(';'));
        const blob = new Blob([arr], { type: mime || 'application/octet-stream' });
        return URL.createObjectURL(blob);
      }

      function revokeBlobUrl(u){
        try{ if (u) URL.revokeObjectURL(u); }catch(_){}
      }

      function enableActions(enable){
        [dlBtn, printBtn].forEach(b=>{
          if (b) b.setAttribute('aria-disabled', String(!enable));
        });
      }

      function generate(){
        if (!fname.value.trim() || !lname.value.trim() || !date.value){
          alert('Molimo unesite ime, prezime i datum.');
          return;
        }

        statusEl.textContent = 'Generišem sertifikat…';

        const payload = {
          first: fname.value.trim(),
          last: lname.value.trim(),
          dateStr: new Date(date.value + 'T00:00:00').toLocaleDateString('sr-Latn-RS'),
          pledge: pledgeTextEl.value,
          accent: getAccent()
        };

        // Export PNG (for preview/download/share) and JPEG (for iOS printing)
        const pngDataUrl = renderHighResDataUrl(payload, 'image/png');
        const jpegDataUrl = renderHighResDataUrl(payload, 'image/jpeg', 0.92);

        // Preview via Blob URL (lighter for the DOM)
        revokeBlobUrl(last.blobUrl);
        const blobUrl = dataUrlToBlobUrl(pngDataUrl);

        certImg.src = blobUrl;
        printCertImg.src = blobUrl;

        // Remember latest exports
        const safeName = [fname.value.trim(), lname.value.trim()]
          .filter(Boolean).join('_').replace(/\s+/g,'-') || 'obecanje';
        last = { pngDataUrl, jpegDataUrl, blobUrl, filename: `obecanje_${safeName}` };

        enableActions(true);
        statusEl.textContent = 'Sertifikat je generisan.';

        // Share text
        const fullName = `${fname.value.trim()} ${lname.value.trim()}`.trim();
        const namePart = consentEl.checked && fullName ? ` (${fullName})` : '';
        const shareText = `Upravo sam potpisao/la moje obećanje povodom Međunarodnog dana demokratije ${CAMPAIGN_YEAR}!${namePart} Pridruži se i potpiši i ti. ${HASHTAGS}`;

        // Wire share buttons (uses PNG data URL for Web Share file)
        SSS.wireShareButtons({
          url: CAMPAIGN_URL,
          title: 'Moje obećanje',
          text: shareText,
          hashtags: HASHTAGS_CSV,
          via: '',
          fileDataUrl: pngDataUrl,
          filename: `${last.filename}.png`
        });
      }

      // Open a minimal window and print the JPEG data URL (best for iOS)
      function printInPopupWithDataUrl(dataUrl){
        const w = window.open('', '_blank');
        if (!w) { alert('Dozvolite iskačuće prozore (pop-up) za štampu.'); return; }

        // Build the document first, then set src immediately to stay in the user-gesture chain
        const html = `<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Štampa</title>
  <style>
    @page { size: A4 portrait; margin: 0; }
    html, body { margin:0; padding:0; background:#fff; }
    img { display:block; width:210mm; height:auto; max-width:100%; margin:0 auto; }
  </style>
</head>
<body>
  <img id="img" alt="Sertifikat za štampu">
  <script>
    (function(){
      var img = document.getElementById('img');
      img.addEventListener('load', function(){
        setTimeout(function(){
          try { window.print(); } catch(_) {}
          setTimeout(function(){ try{ window.close(); }catch(_){ } }, 600);
        }, 50);
      }, { once: true });
      // In case load never fires, allow manual print
      setTimeout(function(){ try{ window.focus(); }catch(_){} }, 300);
    })();
  <\/script>
</body>
</html>`;
        w.document.open();
        w.document.write(html);
        w.document.close();

        // Set the image source as soon as the DOM exists in the popup
        const setSrc = ()=>{
          const img = w.document && w.document.getElementById && w.document.getElementById('img');
          if (img) img.src = dataUrl; else setTimeout(setSrc, 15);
        };
        setSrc();
      }

      // Desktop/Android path: print current page after ensuring the image is decoded
      async function printCurrentPage(){
        const ensureSrc = printCertImg.src || certImg.src;
        if (!ensureSrc){ return; }
        if (!printCertImg.src){ printCertImg.src = ensureSrc; }
        try{
          if (printCertImg.decode) { await printCertImg.decode(); }
          else {
            await new Promise((res)=>{
              if (printCertImg.complete) return res();
              printCertImg.onload = ()=>{ printCertImg.onload = null; res(); };
              printCertImg.onerror = ()=>{ printCertImg.onerror = null; res(); };
            });
          }
        } catch(_) {}
        setTimeout(()=>window.print(), 0);
      }

      async function printSafely(){
        if (!last.pngDataUrl){ return; }
        if (isIOS){
          // Use JPEG data URL in a popup for iOS reliability
          return printInPopupWithDataUrl(last.jpegDataUrl || last.pngDataUrl);
        }
        return printCurrentPage();
      }

      // Events
      genBtn.addEventListener('click', generate);

      dlBtn.addEventListener('click', ()=>{
        if (!last.blobUrl){ return; }
        const a = document.createElement('a');
        a.download = `${last.filename}.png`;
        a.href = last.blobUrl;
        a.click();
      });

      if (printBtn) printBtn.addEventListener('click', printSafely);

      // Initial share wiring (generic text, no file)
      SSS.wireShareButtons({
        url: CAMPAIGN_URL,
        title: 'Moje obećanje',
        text: `Pridružujem se obilježavanju Međunarodnog dana demokratije ${CAMPAIGN_YEAR}. ${HASHTAGS}`,
        hashtags: HASHTAGS_CSV,
        via: ''
      });

      // Init
      enableActions(false);
    })();
  </script>
</body>
</html>
