<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8">
  <title>Potpiši obećanje</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Potpiši obećanje, preuzmi, odštampaj ili podijeli. Podaci se ne čuvaju.">
  <style>
    :root{ --bg:#f7fafc; --card:#ffffff; --ink:#111827; --muted:#4b5563; --border:#e5e7eb; --radius:16px; --shadow:0 10px 24px rgba(0,0,0,.08); --accent:#003869; }
    *{box-sizing:border-box}
    body{margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; background:var(--bg); color:var(--ink)}
    .container{max-width:980px; margin-inline:auto; padding:24px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px}
    h1{margin:0 0 12px; font-size:1.8rem}
    p.muted{color:var(--muted); margin-top:6px}

    form{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    @media (max-width:720px){ form{grid-template-columns:1fr} }
    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-weight:600}
    input{background:#fff; color:var(--ink); border:1px solid #d1d5db; border-radius:10px; padding:10px}

    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .btn{appearance:none; border:1px solid #d1d5db; background:#fff; color:var(--ink); padding:10px 14px; border-radius:10px; cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent); font-weight:700}
    .btn[disabled]{opacity:.55; cursor:not-allowed}

    .pledge-section{margin:16px 0 6px}
    .pledge-section .label{margin-bottom:6px}
    .pledge-preview{line-height:1.6}
    .pledge-preview p{margin:0 0 10px}
    .pledge-preview ul{margin:8px 0 16px 0; padding-left:0; list-style:none}
    .pledge-preview li{position:relative; padding-left:32px; margin:6px 0;}
    .pledge-preview li::before{content:"•"; position:absolute; left:0; top:0; line-height:1.6; color:var(--ink);}

    .canvas-wrap{margin-top:16px}
    #certImg{width:100%; height:auto; display:block; background:#fff; border:1px solid #d1d5db; border-radius:12px}

    .sr-only{ position:absolute !important; width:1px !important; height:1px !important; padding:0 !important; margin:-1px !important; overflow:hidden !important; clip:rect(0,0,0,0) !important; white-space:nowrap !important; border:0 !important; }

    @media print{
      @page { size: A4 portrait; margin: 0; }
      html, body, .container { margin:0 !important; padding:0 !important; }
      body{background:white; color:black}
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .no-print{display:none !important}
      .print-only{display:block !important}
      #printCertImg{ display:block; width:210mm; height:auto; max-width:100%; image-rendering: optimizeQuality; page-break-inside: avoid; break-inside: avoid; page-break-after: avoid; }
    }
    .print-only{display:none}

    .toast{ position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: #111827; color: #fff; padding: 10px 14px; border-radius: 10px; box-shadow: var(--shadow); font-size: .95rem; opacity: 0; pointer-events: none; transition: opacity .25s ease; }
    .toast.show{ opacity: 1; }
    .hint{font-size:.9rem; color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <div class="card no-print">
      <h1>Potpiši obećanje</h1>
      <p class="muted"><i>*Popuni svoje podatke, generiši sertifikat, a zatim ga preuzmi, odštampaj ili podijeli (kopiranjem teksta).</i></p>

      <section class="pledge-section" aria-labelledby="pledge-heading">
        <div class="label" id="pledge-heading">Tekst obećanja</div>
        <div class="pledge-preview" id="pledgeHTML">
          <p>Uviđajući vrijednost i značaj demokratije, ali i prepoznajući izazove i prijetnje sa kojima se ona suočava, globalno i u Crnoj Gori, ovim putem se obavezujem da ću u narednih 365 dana, u skladu sa svojom ulogom, mogućnostima i kapacitetima:</p>
          <ul>
            <li><b>Aktivno učestvovati u demokratskim procesima</b> — koristiti pravo glasa, podsticati građansko angažovanje i doprinositi odgovornosti institucija.</li>
            <li><b>Štititi ljudska prava i jednakost</b> — boriti se protiv diskriminacije i omogućiti puno učešće svih građana i građanki, uključujući žene, mlade i manjinske zajednice.</li>
            <li><b>Promovisati kulturu dijaloga i istinitog informisanja</b> — poštovati različita mišljenja, graditi konsenzus i suprotstavljati se dezinformacijama, uz podršku slobodnih i nezavisnih medija.</li>
            <li><b>Boriti se protiv korupcije i zloupotreba moći</b> — zahtijevati transparentnost, vladavinu prava i izgradnju odgovornih institucija.</li>
            <li><b>Jačati demokratske vrijednosti u zajednici i šire</b> — volontirati, podsticati aktivizam, solidarnost i povezivanje sa drugima u Crnoj Gori i svijetu.</li>
          </ul>
        </div>
      </section>

      <form id="form">
        <div class="field">
          <label for="fname" class="label">Ime</label>
          <input id="fname" name="fname" required autocomplete="given-name" placeholder="Ime">
        </div>
        <div class="field">
          <label for="lname" class="label">Prezime</label>
          <input id="lname" name="lname" required autocomplete="family-name" placeholder="Prezime">
        </div>
        <div class="field">
          <label for="date" class="label">Datum</label>
          <input id="date" name="date" type="date" required>
        </div>
        <div class="field">
          <label class="label">Saglasnost za korišćenje imena u objavama</label>
          <label><input id="consent" type="checkbox"> <span>Saglasan/na sam da se moje ime koristi u objavama</span></label>
        </div>

        <div class="field" style="grid-column:1 / -1">
          <div class="actions">
            <button id="genBtn" class="btn primary" type="button">Generiši sertifikat</button>
            <button id="dlBtn" class="btn" type="button" disabled aria-disabled="true">Preuzmi PNG</button>
            <button id="printBtn" class="btn" type="button" disabled aria-disabled="true">Štampaj / Sačuvaj PDF</button>
            <button id="shareBtn" class="btn" type="button" disabled aria-disabled="true">Podijeli</button>
          </div>
          <p class="hint">Isprintaj, potpiši i čuvaj dokument kao podsjetnik!    |     Proširi glas-> podijeli na socijalne mreže.</p>
          <div id="status" class="sr-only" aria-live="polite"></div>
        </div>
      </form>

      <div class="canvas-wrap">
        <img id="certImg" alt="Pregled sertifikata" />
      </div>
    </div>

    <div class="print-only">
      <img id="printCertImg" alt="Sertifikat za štampu">
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">Tekst je kopiran. Nalijepi ga u objavu.</div>

  <script>
  (function(){
    const genBtn = document.getElementById('genBtn');
    const dlBtn = document.getElementById('dlBtn');
    const printBtn = document.getElementById('printBtn');
    const shareBtn = document.getElementById('shareBtn');
    const consentEl = document.getElementById('consent');
    const statusEl = document.getElementById('status');
    const toastEl = document.getElementById('toast');

    const certImg = document.getElementById('certImg');
    const printCertImg = document.getElementById('printCertImg');

    const fname = document.getElementById('fname');
    const lname = document.getElementById('lname');
    const date = document.getElementById('date');
    try { date.valueAsDate = new Date(); } catch {}

    const BASE_W = 1000, BASE_H = 1400;
    const CAMPAIGN_YEAR = new Date().getFullYear();
    const HASHTAGS = '#IDD2025 #DanDemokratije';

    const isSecure = window.isSecureContext || location.protocol === 'https:';

    function drawWrapped(context, text, x, y, maxWidth, lineHeight){
      const words = text.split(/\s+/); let line = '';
      for (let i=0; i<words.length; i++){
        const test = line ? line + ' ' + words[i] : words[i];
        if (context.measureText(test).width > maxWidth){ context.fillText(line, x, y); line = words[i]; y += lineHeight; }
        else { line = test; }
      }
      if (line){ context.fillText(line, x, y); }
      return y;
    }
    function wrapLines(context, text, maxWidth){
      const words = text.split(/\s+/), lines=[]; let line='';
      for (let i=0;i<words.length;i++){
        const test=line?line+' '+words[i]:words[i];
        if (context.measureText(test).width>maxWidth){ lines.push(line); line=words[i]; }
        else line=test;
      }
      if(line) lines.push(line); return lines;
    }
    function renderParagraphs(context, text, baseX, startY, maxW, lineHeight){
      const paras = text.replace(/\r/g,'').split('\n');
      let y = startY; const bulletGap=16, bulletIndent=28;
      for (let raw of paras){
        const line = raw.trimEnd(); if (!line.trim()){ y += lineHeight; continue; }
        const isBullet = /^([•\-])\s+/.test(line);
        if (isBullet){
          const content = line.replace(/^([•\-])\s+/, '');
          const bulletX = baseX; const textX = baseX + bulletIndent + bulletGap; const avail = maxW - (bulletIndent + bulletGap);
          context.beginPath(); context.fillStyle = '#111827'; context.arc(bulletX + bulletIndent/2, y - 8, 4, 0, Math.PI*2); context.fill();
          y = drawWrapped(context, content, textX, y, avail, lineHeight); y += lineHeight;
        } else {
          y = drawWrapped(context, line, baseX, y, maxW, lineHeight); y += lineHeight;
        }
      }
      return y;
    }
    function drawCertificate(context, { first, last, dateStr, pledge, accent }){
      context.clearRect(0, 0, BASE_W, BASE_H);
      context.fillStyle = '#ffffff'; context.fillRect(0, 0, BASE_W, BASE_H);
      const pad=64, bodyPad=70;
      context.strokeStyle = accent; context.lineWidth = 6; context.strokeRect(pad, pad, BASE_W - pad*2, BASE_H - pad*2);
      context.strokeStyle = accent; context.lineWidth = 3; context.setLineDash([10,8]); context.strokeRect(pad+18, pad+18, BASE_W - (pad+18)*2, BASE_H - (pad+18)*2); context.setLineDash([]);
      context.fillStyle = '#111827'; context.textAlign='center'; context.font='bold 40px Georgia, "Times New Roman", serif'; context.fillText('MOJE OBEĆANJE', BASE_W/2, 180);
      context.font='24px Georgia, "Times New Roman", serif'; context.fillStyle='#374151'; context.fillText('Povodom 15. septembra — Međunarodnog dana demokratije', BASE_W/2, 230);
      const fullName = (first + ' ' + last).trim(); context.font='bold 40px Georgia, "Times New Roman", serif'; context.fillStyle='#111827'; context.fillText(fullName || '—', BASE_W/2, 300);
      context.strokeStyle = '#111827'; context.lineWidth = 2; const nameWidth = context.measureText(fullName || '—').width; const ruleW = Math.min(720, Math.max(360, nameWidth + 80)); context.beginPath(); context.moveTo((BASE_W - ruleW)/2, 318); context.lineTo((BASE_W + ruleW)/2, 318); context.stroke();
      context.textAlign='left'; context.fillStyle='#111827'; context.font='24px Georgia, "Times New Roman", serif'; const bodyX = pad + bodyPad; const bodyY=380; const bodyW = BASE_W - (pad + bodyPad) * 2; const lineH=36; renderParagraphs(context, pledge.trim(), bodyX, bodyY, bodyW, lineH);
      context.font='20px Georgia, "Times New Roman", serif'; context.fillStyle='#374151'; const leftX = pad + bodyPad; const rightX = BASE_W - pad - bodyPad; context.fillText('Datum:', leftX, BASE_H - 180); context.fillStyle='#111827'; context.fillText(dateStr || '—', leftX + 90, BASE_H - 180);
      context.strokeStyle = '#111827'; context.lineWidth = 2; context.beginPath(); context.moveTo(rightX - 320, BASE_H - 190); context.lineTo(rightX, BASE_H - 190); context.stroke(); context.fillStyle='#374151'; context.textAlign='right'; context.fillText('Potpis', rightX - 120, BASE_H - 160);
      const closing='Potpisivanjem ove izjave postajem dio globalne zajednice koja slavi i jača demokratiju — danas i svakoga dana.'; context.textAlign='center'; context.fillStyle='#374151'; context.font='14px Georgia, "Times New Roman", serif'; const closingMaxW = BASE_W - pad*2 - 100; const lines = wrapLines(context, closing, closingMaxW); const startY = BASE_H - 100 - ((lines.length - 1) * 26) / 2; lines.forEach((ln,i)=>context.fillText(ln, BASE_W/2, startY + i * 26));
    }

    function htmlToPlainPledge(){
      const root = document.getElementById('pledgeHTML');
      const parts = [];
      root.querySelectorAll('p, li').forEach(el=>{
        const t = el.textContent.trim();
        if(!t) return;
        if(el.tagName === 'LI') parts.push('\u2022 ' + t);
        else parts.push(t + '\n');
      });
      return parts.join('\n');
    }

    function renderHighRes(payload){
      const A4_W = 2480; const scale = A4_W / BASE_W; const off = document.createElement('canvas'); off.width = Math.round(BASE_W * scale); off.height = Math.round(BASE_H * scale); const octx = off.getContext('2d'); octx.setTransform(scale,0,0,scale,0,0); drawCertificate(octx, payload); return off.toDataURL('image/png');
    }

    function enableActions(enable){ [dlBtn, printBtn, shareBtn].forEach(b=>{ b.disabled = !enable; b.setAttribute('aria-disabled', String(!enable)); }); }

    function getShareText(){
      return `Upravo sam potpisao/la moje obećanje povodom Međunarodnog dana demokratije ${CAMPAIGN_YEAR}! Pridruži se i potpiši i ti. ${window.location.href} ${HASHTAGS}`;
    }

    let toastTimer = null; function showToast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); clearTimeout(toastTimer); toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 2200); }

    async function copyShareText(){
      const text = getShareText();
      try{
        if (navigator.clipboard && isSecure){ await navigator.clipboard.writeText(text); }
        else { const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
        showToast('Tekst je kopiran. Nalijepi ga u objavu.');
      } catch(e){ /* ignore */ }
    }

    async function shareCertificate(){
      const shareUrl = window.location.href;
      const shareTitle = "Moje obećanje";
      const shareText = getShareText();

      if (navigator.share) {
        try {
          await navigator.share({
            title: shareTitle,
            text: shareText,
            url: shareUrl,
          });
        } catch (error) {
          console.error('Error sharing:', error);
          // Fallback to copying text if native sharing fails
          copyShareText();
        }
      } else {
        // Fallback for browsers without native share support
        copyShareText();
      }
    }

    async function printSafely(){
      const ensureSrc = printCertImg.src || certImg.src; if (!ensureSrc) return;
      if (!printCertImg.src) printCertImg.src = ensureSrc;
      try{ if (printCertImg.decode) await printCertImg.decode(); }catch(_){ }
      setTimeout(()=>window.print(),0);
    }

    function generate(){
      if (!fname.value.trim() || !lname.value.trim() || !date.value){ alert('Molimo unesite ime, prezime i datum.'); return; }
      statusEl.textContent = 'Generišem sertifikat…';
      const payload = { first: fname.value.trim(), last: lname.value.trim(), dateStr: new Date(date.value + 'T00:00:00').toLocaleDateString('sr-RS'), pledge: htmlToPlainPledge(), accent: getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#003869' };
      const exportUrl = renderHighRes(payload); certImg.src = exportUrl; printCertImg.src = exportUrl; enableActions(true); statusEl.textContent = 'Sertifikat je generisan (PNG).';
    }

    // Events
    genBtn.addEventListener('click', generate);
    dlBtn.addEventListener('click', ()=>{ const safe=[fname.value.trim(), lname.value.trim()].filter(Boolean).join('_').replace(/\s+/g,'-')||'obecanje'; const a=document.createElement('a'); a.download=`obecanje_${safe}.png`; a.href=printCertImg.src||certImg.src; if (a.href) a.click(); });
    printBtn.addEventListener('click', printSafely);
    shareBtn.addEventListener('click', shareCertificate);

    // Init
    enableActions(false);
  })();
  </script>
</body>
</html>
